#!/bin/sh
# udhcpc iproute2 module for net-scripts
# Version 1.0.0
# Copyright (c) 2004 Gentoo Foundation
# Distributed under the terms of the GNU General Public License V2
# Contributed by Roy Marples (uberlord@gentoo.org)

action=${1}
echo ${action}

case "${action}" in
	bound|renew|deconfig)
		# We handle these actions
		;;
	nak|leasefail)
		# These are valid actions, but we don't handle them
		exit 0
		;;
	*)
		echo "We don't handle that action"
		exit 1
		;;
esac

[[ ${action} == nak ]] && exit 0

# Fix any potential localisation problems
# Note that LC_ALL trumps LC_anything_else according to locale(7)
ip() {
	LC_ALL=C /sbin/ip "$@"
}

# We don't flush the link local address
ip addr flush dev ${interface} scope global &>/dev/null
ip addr flush dev ${interface} scope host &>/dev/null
ip link set up dev ${interface} &>/dev/null

[[ -z ${MODULES_DIR} ]] && MODULES_DIR=/lib/rcscripts/net.modules.d
source ${MODULES_DIR}/helpers.d/config-system

if [[ ${action} == deconfig ]]; then
	restore_configs
	exit 0
fi

# Configure our IP address(es)
ip=( ${ip} )
subnet=( ${subnet} )
broadcast=( ${broadcast} )
for (( i=0; i<${#ip[@]}; i++ )); do
	cidr=$( netmask2cidr ${subnet[i]} )
		b=${broadcast[i]}
	[[ -n ${b} ]] && b="broadcast ${b}"
		ip addr add dev ${interface} ${ip[i]}/${cidr} ${b}
done

# Configure our routers
for r in ${router}; do
	# We can only have one default route!
	ip route add default via ${r} dev ${interface} 2>/dev/null && break
done

# Set our module to udhcpc if it's not set
[[ -z ${module} ]] && module=udhcpc

config_system

exit 0
