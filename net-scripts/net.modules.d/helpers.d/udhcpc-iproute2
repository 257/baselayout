#!/bin/sh
# udhcpc iproute2 module for net-scripts
# Version 1.0.0
# Copyright (c) 2004 Gentoo Foundation
# Distributed under the terms of the GNU General Public License V2
# Contributed by Roy Marples (uberlord@gentoo.org)

action=${1}
echo ${action}

case "${action}" in
	bound|renew|deconfig|nak)
		# We handle these actions
		;;
	*)
		echo "We don't handle that action"
		exit 1
		;;
esac

[[ ${action} == nak ]] && exit 0

# We don't flush the link local address
ip addr flush ${interface} scope global &>/dev/null
ip addr flush ${interface} scope host &>/dev/null
ip route flush ${interface} &>/dev/null
ip link set up dev ${interface} &>/dev/null

[[ ${action} == deconfig ]] && exit 0

if [[ ${action} == bound ]]; then
	ip=( ${ip} )
	subnet=( ${subnet} )
	broadcast=( ${broadcast} )
	for (( i=0; i<${#ip[@]}; i++ )); do
		[[ ${i} -eq 0 ]] && l=${interface} || l=${interface}:${i}

		# We need to translate 255.255.255.0 into 24
		len=0
		for x in ${subnet[i]//./}; do
			binary=$( echo "obase=2; ${x}" | bc )
			for (( j=0; j<${#binary}; j++)) do
				[[ ${binary:${j}:1} -eq 1 ]] && (( len++ ))
			done
		done

		/sbin/ip addr add dev ${interface} label ${l} ${ip[i]}/${len} broadcast ${broadcast[i]}
	done

	for r in ${router}; do
		x=$( /sbin/ip route show | awk '{ if ($1 == "default") {print $1} }' )
		if [[ -n ${x} ]]; then
			x=$( /sbin/ip route change default via ${r} dev ${interface} 2>&1 )
		else
			x=$( /sbin/ip route add default via ${r} dev ${interface} 2>&1 )
		fi
		case "${x}" in
			'RTNETLINK answers: File exists'|'') ;;
			*) printf '%s\n' "${x}" >&2 ;;
		esac
	done
fi

# Set our module to udhcpc if it's not set
[[ -z ${module} ]] && module=udhcpc
source /lib/rcscripts/net.modules.d/helpers.d/config-system
config_system

exit 0
