#!/sbin/runscript
# Copyright 1999-2004 Gentoo Foundation
# Distributed under the terms of the GNU General Public License v2
# $Header$

depend() {
	need checkroot hostname
	before bootmisc
}

checkconfig_nis() {
	if [ ! -f /etc/nisdomainname ] || [ -z "$(< /etc/nisdomainname)" ]
	then
#		eerror "You need to set /etc/nisdomainname to a valid NIS domainname"
		return 1
	fi
	return 0
}

checkconfig_dns() {
	if [ ! -f /etc/dnsdomainname ] || [ -z "$(< /etc/dnsdomainname)" ]
	then
#		eerror "You need to set /etc/dnsdomainname to a valid DNS domainname"
		return 1
	fi

	mydnsdomain="$(< /etc/dnsdomainname)"

	if ! touch /etc/dnsdomainname 2> /dev/null
	then
		ewarn "Unable to set domain in resolv.conf (ro root?)"
		return 1
	fi

	return 0
}

start() {
	local mynisdomain=
	local mydnsdomain=
	local retval=0
	local retval2=0

	if checkconfig_nis
	then
		mynisdomain="$(< /etc/nisdomainname)"

		ebegin "Setting NIS domainname to ${mynisdomain}"
		/bin/domainname "${mynisdomain}"
		retval=$?
		eend ${retval} "Failed to set the NIS domainname"
		
	fi

	if checkconfig_dns
	then
		[ ! -f /etc/resolv.conf ] && touch /etc/resolv.conf
		ebegin "Setting DNS domainname to ${mydnsdomain}"
		gawk -v DOMAIN="${mydnsdomain}" \
			'END { print "domain " DOMAIN }
			 $0 !~ /^[[:space:]]*domain/ { print }' \
			/etc/resolv.conf > /etc/resolv.conf.new
		retval2=$?
		[ "${retval2}" -eq 0 ] \
			&& (mv -f /etc/resolv.conf.new /etc/resolv.conf) \
			|| (rm -f /etc/resolv.conf.new)
		eend ${retval2} "Failed to set the DNS domainname"
	fi

	return $((retval + retval2))
}


# vim:ts=4
