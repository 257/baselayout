#!/sbin/runscript
# Copyright 1999-2002 Gentoo Technologies, Inc.
# Distributed under the terms of the GNU General Public License, v2 or later
# $Header$


depend() {
	need clock localmount
}

start() {
	if [ "$BOOT" = "yes" ]
	then
		# Put a nologin file in /etc to prevent people from logging in before
		# system startup is complete.
		if [ "$DELAYLOGIN" = "yes" ]
		then
			echo "System bootup in progress - please wait" > /etc/nologin
			cp /etc/nologin /etc/nologin.boot >/dev/null 2>&1
		fi

		if [ -e /etc/sysctl.conf ]
		then
			ebegin "Configuring kernel parameters"
			sysctl -p /etc/sysctl.conf >/dev/null 2>&1
			eend 0
		fi

		#
		# Clean up any stale locks.
		#
		ebegin "Cleaning /var/lock, /var/run"
		( cd /var/lock && find . -type f -exec rm -f -- {} \; 1>&2 )
		#
		# Clean up /var/run and create /var/run/utmp so that we can login.
		#
		( cd /var/run && \
			find . ! -type d ! -name utmp ! -name innd.pid ! -name random-seed \
			-exec rm -f -- {} \; 1>&2 )
		: > /var/run/utmp
		eend 0

		#
		# Clean up /tmp directory
		#
		ebegin "Cleaning /tmp directory"
		rm -f /tmp/.X*-lock >/dev/null 2>&1
		rm -f /tmp/esrv* >/dev/null 2>&1
		rm -f /tmp/kio* >/dev/null 2>&1
		rm -f /tmp/jpsock.* >/dev/null 2>&1
		rm -rf /tmp/.esd* >/dev/null 2>&1
		rm -rf /tmp/orbit-* >/dev/null 2>&1
		rm -rf /tmp/ssh-* >/dev/null 2>&1
		rm -rf /tmp/ksocket-* >/dev/null 2>&1
		rm -rf /tmp/.*-unix >/dev/null 2>&1
		eend 0
	fi

	#
	# Check for /etc/resolv.conf, and create if missing
	#
	[ -f /etc/resolv.conf ] || touch /etc/resolv.conf >/dev/null 2>&1

	if [ -c /dev/ttyp0 ]
	then
		chmod 666 /dev/tty[p-za-e][0-9a-f] >/dev/null 2>&1
		chown root:tty /dev/tty[p-za-e][0-9a-f] >/dev/null 2>&1
	fi
}

